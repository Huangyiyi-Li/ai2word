# MD2Word v2.3 功能需求规格说明 (PRD)

## 1. 目标描述

进一步增强插件版与网页版的转换能力，使其能够自动处理从主流 AI 对话平台抓取的 HTML 内容，并精准还原为复杂的 Word 结构（如脚注、嵌套样式等）。

## 2. 核心功能改进

### 2.1 会话内容自动抓取 (Capture Mode)

- **HTML 会话解析**：
  - 自动识别 `<sup>` 标签并转换为 `[^id]` 引用。
  - 检测锚点链接（`#fn`）及 `footnote-ref` 类，自动提取脚注编号。
  - 自动识别对话末尾的 `<li>` 列表项中的脚注定义（ID 包含 `fn`），转换为 `[^id]: content` 格式。
- **跨端同步**：
  - 确保 `content.js` 抓取的 HTML 片段在经过 `domToMarkdown` 转换后，能够无缝触发 `converter.js` 的 v2.2 解析引擎。

### 2.2 手动模式增强 (Manual Mode)

- **高级解析引擎注入**：
  - 手动输入模式全面启用 `hasRichContent` 检测。
  - 支持加粗、斜体、删除线、超链接、脚注、LaTeX、Mermaid 的混合解析。
- **样式一致性**：
  - 保证手动粘入的 Markdown 代码块与对话抓取的代码块具有相同的 Word 样式表现。

### 2.3 核心解析算法修复 (v2.2 Logic Payload)

- **指针步进修复**：解决脚注匹配后 `lastIndex` 未步进导致的字符重复问题。
- **段落路由优化**：通过检测特征字符，确保非公式段落也能正确走入 `parseInlineContent` 执行流。

## 3. 验收标准

1. **AI 对话测试**：抓取带脚注的 AI 回复（如 DeepSeek 回复），导出的 Word 应显示正文角标及页脚注释。
2. **超链接测试**：对话中的点击链接或手动录入的 `[text](url)` 应保持蓝色下划线可点击状态。
3. **嵌套测试**：混合内容（如加粗文本中包含公式且带脚注）解析正常，无乱码。

---
*Created: 2026-02-04*
